<script>
    // Endereço limpo e sem caracteres especiais
    const CONTRACT_ADDR = "0x515f564904E22713f15b56fdE37Cf6d23dBf7037";
    
    // ABI simplificada para evitar erros de parsing
    const ABI = [
        "function claim() external",
        "function hasClaimed(address) public view returns (bool)"
    ];

    let walletAddress = "";

    document.getElementById('connectBtn').onclick = async () => {
        if (!window.ethereum) { 
            alert("Instala a MetaMask primeiro!"); 
            return; 
        }
        try {
            // Garante que estamos a pedir as contas corretamente
            const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
            walletAddress = accounts[0];
            
            // Ativa a interface
            document.getElementById('connectBtn').style.display = 'none';
            document.getElementById('claimContainer').style.display = 'block';
            document.getElementById('status').innerText = "Ligado: " + walletAddress.substring(0,6) + "...";
            
            console.log("Conectado com sucesso ao endereço:", walletAddress);
        } catch (e) { 
            console.error("Erro na conexão:", e);
            document.getElementById('status').innerText = "Erro ao ligar a carteira."; 
        }
    };

    document.getElementById('claimBtn').onclick = async () => {
        try {
            const provider = new ethers.providers.Web3Provider(window.ethereum);
            const signer = provider.getSigner();
            
            // Criar o contrato garantindo que o endereço é uma String pura
            const contract = new ethers.Contract(CONTRACT_ADDR.trim(), ABI, signer);

            document.getElementById('status').innerText = "A enviar transação para a rede Tempo...";
            
            const tx = await contract.claim();
            document.getElementById('status').innerText = "Transação enviada! A aguardar confirmação...";
            
            await tx.wait();
            document.getElementById('status').innerText = "Sucesso! Starter Kit resgatado.";
            confetti();
        } catch (e) { 
            console.error("Erro no Claim:", e);
            // Mensagem amigável para o utilizador
            if (e.message.includes("user rejected")) {
                document.getElementById('status').innerText = "Transação cancelada pelo utilizador.";
            } else {
                document.getElementById('status').innerText = "Erro: Já resgataste ou saldo insuficiente.";
            }
        }
    };
</script>
